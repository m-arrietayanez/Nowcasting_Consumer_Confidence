---
title: "Final Data Analysis"
author: "Mariana Arrieta Yanez"
date: "7/10/2021"
output: html_document
---
#### Data Loading


```{r, message=FALSE, echo=FALSE}
library(tidyverse)
library(data.table)
library(lubridate)
library(gtrendsR)
library(janitor)
library(tools)
library(bsts)
library(scales)
library(writexl)

```

```{r}
#Load all csv files in folder
temp = list.files(pattern="*.csv")
for (i in 1:length(temp)) assign(file_path_sans_ext(temp[i]), read.csv(temp[i]))

#Load google trends categories
data("categories")

#Convert ID number from character to integer to merge later
categories <- categories %>%
  mutate(id = as.integer(id)) %>%
  rename(category = id) %>%
  distinct() 
```

#### Data Cleaning and Processing

##### Google Trends Data
```{r, message=FALSE, warning=FALSE}

#Argentina
arg_dfs <- list(arg_2017_2019, arg_2019_2021)
for(i in 1:2) { 
 nam <- paste("arg", i, sep = "")
 assign(nam, processing_gt_monthly(arg_dfs[i]))
}

#Brasil
bra_dfs <- list(bra_2017_2019, bra_2019_2021)
for(i in 1:2) { 
 nam <- paste("bra", i, sep = "")
 assign(nam, processing_gt_monthly(bra_dfs[i]))
}


#Colombia
col_dfs <- list(col_2017_2019, col_2019_2021)
for(i in 1:2) { 
 nam <- paste("col", i, sep = "")
 assign(nam, processing_gt_monthly(col_dfs[i]))
}


#Chile
chi_dfs <- list(chi_2017_2019, chi_2019_2021)
for(i in 1:2) { 
 nam <- paste("chi", i, sep = "")
 assign(nam, processing_gt_monthly(chi_dfs[i]))
}



#Mexico
mex_dfs <- list(mex_2017_2019, mex_2019_2021)
for(i in 1:2) { 
 nam <- paste("mex", i, sep = "")
 assign(nam, processing_gt_monthly(mex_dfs[i]))
}



```

##### Consumer Confidence 


```{r}
#LOAD CONSUMER CONFIDENCE DATA#

#Argentina
cc_arg <- process_cc("argentina")

#Brasil
cc_bra <- process_cc("brasil")

#Chile
cc_chi <- process_cc("chile")

#Colombia
cc_col <- process_cc("colombia")

#Mexico
cc_mex <- process_cc("mexico")
```


```{r}
#MERGE CONSUMER CONFIDENCE DATA WITH GOOGLE TRENDS DATA

#Argentina
df_arg_2019 <- merge_and_label(df_gt = arg1, df_cc = cc_arg)

df_arg_2021 <- merge_and_label(arg2, cc_arg)


#Brasil
df_bra_2019 <- merge_and_label(df_gt = bra1, df_cc = cc_bra)

df_bra_2021 <- merge_and_label(bra2, cc_bra)

#Chile
df_chi_2019 <- merge_and_label(df_gt = chi1, df_cc = cc_chi)

df_chi_2021 <- merge_and_label(chi2, cc_chi)

#Colombia
df_col_2019 <- merge_and_label(df_gt = col1, df_cc = cc_col)

df_col_2021 <- merge_and_label(col2, cc_col)

#Mexico
df_mex_2019 <- merge_and_label(df_gt = mex1, df_cc = cc_mex)

df_mex_2021 <- merge_and_label(mex2, cc_mex)
```

#### Split Training and Test Sets
```{r}

#ARGENTINA

#2017-2019

my_list <- split_train_test(df_arg_2019, initial_year = 2017)
train_arg <- my_list$train
test_arg_oct <- my_list$test_oct
test_arg_nov <- my_list$test_nov
test_arg_dec <- my_list$test_dec

#2019-2021

my_list <- split_train_test(df_arg_2021, initial_year = 2019)
train_arg_21 <- my_list$train
test_arg_21_apr  <- my_list$test_apr
test_arg_21_may  <- my_list$test_may
test_arg_21_jun  <- my_list$test_jun
```

```{r}

#BRASIL

#2017-2019

my_list <- split_train_test(df_bra_2019, initial_year = 2017)
train_bra <- my_list$train
test_bra_oct <- my_list$test_oct
test_bra_nov <- my_list$test_nov
test_bra_dec <- my_list$test_dec

#2019-2021

my_list <- split_train_test(df_bra_2021, initial_year = 2019)
train_bra_21 <- my_list$train
test_bra_21_apr  <- my_list$test_apr
test_bra_21_may  <- my_list$test_may
test_bra_21_jun  <- my_list$test_jun
```


```{r}

#CHILE

#2017-2019

my_list <- split_train_test(df_chi_2019, initial_year = 2017)
train_chi <- my_list$train
test_chi_oct <- my_list$test_oct
test_chi_nov <- my_list$test_nov
test_chi_dec <- my_list$test_dec

#2019-2021

my_list <- split_train_test(df_chi_2021, initial_year = 2019)
train_chi_21 <- my_list$train
test_chi_21_apr  <- my_list$test_apr
test_chi_21_may  <- my_list$test_may
test_chi_21_jun  <- my_list$test_jun
```


```{r}

#COLOMBIA

#2017-2019

my_list <- split_train_test(df_col_2019, initial_year = 2017)
train_col <- my_list$train
test_col_oct <- my_list$test_oct
test_col_nov <- my_list$test_nov
test_col_dec <- my_list$test_dec

#2019-2021

my_list <- split_train_test(df_col_2021, initial_year = 2019)
train_col_21 <- my_list$train
test_col_21_apr  <- my_list$test_apr
test_col_21_may  <- my_list$test_may
test_col_21_jun  <- my_list$test_jun
```


```{r}

#MEXICO

#2017-2019

my_list <- split_train_test(df_mex_2019, initial_year = 2017)
train_mex <- my_list$train
test_mex_oct <- my_list$test_oct
test_mex_nov <- my_list$test_nov
test_mex_dec <- my_list$test_dec

#2019-2021

my_list <- split_train_test(df_mex_2021, initial_year = 2019)
train_mex_21 <- my_list$train
test_mex_21_apr  <- my_list$test_apr
test_mex_21_may  <- my_list$test_may
test_mex_21_jun  <- my_list$test_jun
```

#### Modeling and Results

##### Argentina 

###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_arg_19 <- bsts_run(y = train_arg$cc, model_spec = train_arg$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_arg_21 <- bsts_run(y = train_arg_21$cc, model_spec = train_arg_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_arg_19 <- bsts_run(y = train_arg$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_arg)

#2019-2021
model_w_gt_arg_21 <- bsts_run(y = train_arg_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_arg_21)
```


###### BSTS with Google Trends' Categories and Priors

```{r}
model_w_priors_arg_2019 <- bsts_run_w_prior(y = train_arg$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_arg, 
                                            initial_year = 2017, 
                                            spike = 0.8, 
                                            model_size = 4)

model_w_priors_arg_2021 <- bsts_run_w_prior(y = train_arg_21$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_arg_21, 
                                            initial_year = 2019, 
                                            spike = 0.2, 
                                            model_size = 4)
```
###### Results


```{r}
### WITHOUT REGRESSION
#Get the posterior distribution of y and plot it 
pred_wo_gt_arg_19 <- prediction_df_and_plot(model= model_wo_gt_arg_19, 
                                              full_df= df_arg_2019, 
                                              train_df= train_arg, 
                                              test_1= test_arg_oct, 
                                              test_2= test_arg_nov, 
                                              test_3= test_arg_dec, 
                                              reg= FALSE, 
                                            test_year = 2019)

pred_wo_gt_arg_19$plot


pred_wo_gt_arg_21 <- prediction_df_and_plot(model= model_wo_gt_arg_21, 
                                              pred_horizon= 3, 
                                              full_df= df_arg_2021, 
                                              train_df= train_arg_21, 
                                              test_1= test_arg_21_apr, 
                                              test_2= test_arg_21_may, 
                                              test_3= test_arg_21_jun,
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_arg_21$plot
```

```{r}
### WITH REGRESSION

#Get the posterior distribution of y and plot it 
pred_w_gt_arg_19 <- prediction_df_and_plot(model= model_w_gt_arg_19, 
                                              full_df= df_arg_2019, 
                                              train_df= train_arg, 
                                              test_1= test_arg_oct, 
                                              test_2= test_arg_nov, 
                                              test_3= test_arg_dec, 
                                              reg= TRUE)

pred_w_gt_arg_19$plot

pred_w_gt_arg_21 <- prediction_df_and_plot(model= model_w_gt_arg_21, 
                                              full_df= df_arg_2021, 
                                              train_df= train_arg_21, 
                                              test_1= test_arg_21_apr, 
                                              test_2= test_arg_21_may, 
                                              test_3= test_arg_21_jun,
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_arg_21$plot
```

```{r}
### WITH REGRESSION AND PRIORS ON CHOSEN CATEGORIES

##2017-2019
pred_w_priors_arg_2019 <- prediction_df_and_plot(model= model_w_priors_arg_2019, 
                                              full_df= df_arg_2019, 
                                              train_df= train_arg, 
                                              test_1= test_arg_oct, 
                                              test_2= test_arg_nov, 
                                              test_3= test_arg_dec, 
                                              reg= TRUE, 
                                              prior = TRUE)

pred_w_priors_arg_2019$plot



##2019-2021
pred_w_priors_arg_2021 <- prediction_df_and_plot(model= model_w_priors_arg_2021, 
                                              pred_horizon= 3, 
                                              full_df= df_arg_2021, 
                                              train_df= train_arg_21, 
                                              test_1= test_arg_21_apr, 
                                              test_2= test_arg_21_may, 
                                              test_3= test_arg_21_jun,
                                              test_year= 2021,
                                              reg= TRUE,
                                              prior = TRUE)

pred_w_priors_arg_2021$plot
```


```{r}
#Errors
mape_w_gt_arg_19 <- get_errors(MAPE_df = pred_w_gt_arg_19$MAPE_raw, test_year = 2019, country = "Argentina", reg = TRUE)
mape_wo_gt_arg_19 <- get_errors(MAPE_df = pred_wo_gt_arg_19$MAPE_raw, test_year = 2019, country = "Argentina", reg = FALSE)
mape_w_gt_arg_21 <- get_errors(MAPE_df = pred_w_gt_arg_21$MAPE_raw, test_year = 2021, country = "Argentina", reg = TRUE)
mape_wo_gt_arg_21 <- get_errors(MAPE_df = pred_wo_gt_arg_21$MAPE_raw, test_year = 2021, country = "Argentina", reg = FALSE)
mape_w_priors_arg_19 <- get_errors(MAPE_df = pred_w_priors_arg_2019$MAPE_raw, test_year = 2019, country = "Argentina", reg = TRUE)
mape_w_priors_arg_21 <- get_errors(MAPE_df = pred_w_priors_arg_2021$MAPE_raw, test_year = 2021, country = "Argentina", reg = TRUE)
```

#### Spike and Slab Exploration
```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_arg_19, 0.2)
var_inclusion_bsts(model_w_gt_arg_19, 0.01)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_arg_21, 0.2)
var_inclusion_bsts(model_w_gt_arg_21, 0.04)
```

```{r}
#BSTS Decomposition
PlotBstsComponents(model_w_gt_arg_19,
                     burn = SuggestBurn(.1, model_w_gt_arg_19),
                     same.scale = FALSE,
                   time = as.Date(rownames(train_arg)),
                     layout = "horizontal",
                     style = "dynamic") 


PlotBstsComponents(model_w_priors_arg_2019,
                     burn = SuggestBurn(.1,model_w_priors_arg_2019),
                   time = as.Date(rownames(train_arg)),
                     same.scale = FALSE,
                     layout = "horizontal",
                     style = "dynamic")

PlotBstsComponents(model_w_priors_arg_2021,
                     burn = SuggestBurn(.1, model_w_priors_arg_2021),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_arg_21)),
                     layout = "horizontal",
                     style = "dynamic")

PlotBstsComponents(model_w_gt_arg_21,
                     burn = SuggestBurn(.1, model_w_gt_arg_21),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_arg_21)),
                     layout = "horizontal",
                     style = "dynamic")

```
##### Brasil 
###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_bra_19 <- bsts_run(y = train_bra$cc, model_spec = train_bra$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_bra_21 <- bsts_run(y = train_bra_21$cc, model_spec = train_bra_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_bra_19 <- bsts_run(y = train_bra$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_bra)

#2019-2021
model_w_gt_bra_21 <- bsts_run(y = train_bra_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_bra_21)

```

###### BSTS with Google Trends' Categories and Priors

```{r}
model_w_priors_bra_2019 <- bsts_run_w_prior(y = train_bra$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_bra, 
                                            initial_year = 2017, 
                                            spike = 0.8, 
                                            model_size = 4)

model_w_priors_bra_2021 <- bsts_run_w_prior(y = train_bra_21$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_bra_21, 
                                            initial_year = 2019, 
                                            spike = 0.2, 
                                            model_size = 4)
```

###### Results


```{r}
### WITHOUT REGRESSION
#Get the posterior distribution of y and plot it 
pred_wo_gt_bra_19 <- prediction_df_and_plot(model= model_wo_gt_bra_19, 
                                              full_df= df_bra_2019, 
                                              train_df= train_bra, 
                                              test_1= test_bra_oct, 
                                              test_2= test_bra_nov, 
                                              test_3= test_bra_dec, 
                                              reg= FALSE, 
                                            test_year = 2019)

pred_wo_gt_bra_19$plot


pred_wo_gt_bra_21 <- prediction_df_and_plot(model= model_wo_gt_bra_21, 
                                              pred_horizon= 3, 
                                              full_df= df_bra_2021, 
                                              train_df= train_bra_21, 
                                              test_1= test_bra_21_apr, 
                                              test_2= test_bra_21_may, 
                                              test_3= test_bra_21_jun,
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_bra_21$plot
```

```{r}
### WITH REGRESSION

#Get the posterior distribution of y and plot it 
pred_w_gt_bra_19 <- prediction_df_and_plot(model= model_w_gt_bra_19, 
                                              full_df= df_bra_2019, 
                                              train_df= train_bra, 
                                              test_1= test_bra_oct, 
                                              test_2= test_bra_nov, 
                                              test_3= test_bra_dec, 
                                              reg= TRUE)

pred_w_gt_bra_19$plot

pred_w_gt_bra_21 <- prediction_df_and_plot(model= model_w_gt_bra_21, 
                                              full_df= df_bra_2021, 
                                              train_df= train_bra_21, 
                                              test_1= test_bra_21_apr, 
                                              test_2= test_bra_21_may, 
                                              test_3= test_bra_21_jun,
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_bra_21$plot
```


```{r}
### WITH REGRESSION AND PRIORS ON CHOSEN CATEGORIES

##2017-2019
pred_w_priors_bra_2019 <- prediction_df_and_plot(model= model_w_priors_bra_2019, 
                                              full_df= df_bra_2019, 
                                              train_df= train_bra, 
                                              test_1= test_bra_oct, 
                                              test_2= test_bra_nov, 
                                              test_3= test_bra_dec, 
                                              reg= TRUE, 
                                              prior = TRUE)

pred_w_priors_bra_2019$plot



##2019-2021
pred_w_priors_bra_2021 <- prediction_df_and_plot(model= model_w_priors_bra_2021, 
                                              pred_horizon= 3, 
                                              full_df= df_bra_2021, 
                                              train_df= train_bra_21, 
                                              test_1= test_bra_21_apr, 
                                              test_2= test_bra_21_may, 
                                              test_3= test_bra_21_jun,
                                              test_year= 2021,
                                              reg= TRUE,
                                              prior = TRUE)

pred_w_priors_bra_2021$plot
```


```{r}
#Errors
mape_w_gt_bra_19 <- get_errors(MAPE_df = pred_w_gt_bra_19$MAPE_raw, test_year = 2019, country = "Brazil", reg = TRUE)
mape_wo_gt_bra_19 <- get_errors(MAPE_df = pred_wo_gt_bra_19$MAPE_raw, test_year = 2019, country = "Brazil", reg = FALSE)
mape_w_gt_bra_21 <- get_errors(MAPE_df = pred_w_gt_bra_21$MAPE_raw, test_year = 2021, country = "Brazil", reg = TRUE)
mape_wo_gt_bra_21 <- get_errors(MAPE_df = pred_wo_gt_bra_21$MAPE_raw, test_year = 2021, country = "Brazil", reg = FALSE)
mape_w_priors_bra_19 <- get_errors(MAPE_df = pred_w_priors_bra_2019$MAPE_raw, test_year = 2019, country = "Brazil", reg = TRUE)
mape_w_priors_bra_21 <- get_errors(MAPE_df = pred_w_priors_bra_2021$MAPE_raw, test_year = 2021, country = "Brazil", reg = TRUE)
```

#### Spike and Slab Exploration
```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_bra_19, 0.15)
var_inclusion_bsts(model_w_gt_bra_19, 0.01)

#Relevant variables 2019-2021
param_values_bsts(models_w_prior_bra_2019[[1]], 0.01)
var_inclusion_bsts(models_w_prior_bra_2019[[1]], 0.01)
```
```{r}


PlotBstsComponents(model_w_gt_bra_21,
                     burn = SuggestBurn(.1, model_w_gt_bra_21),
                   time = as.Date(rownames(train_bra_21)),
                     same.scale = FALSE,
                     layout = "horizontal",
                     style = "dynamic")


PlotBstsComponents(model_wo_gt_bra_21,
                     burn = SuggestBurn(.1, model_wo_gt_bra_21),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_bra_21)),
                     layout = "horizontal",
                     style = "dynamic")

```

##### Chile
###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_chi_19 <- bsts_run(y = train_chi$cc, model_spec = train_chi$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_chi_21 <- bsts_run(y = train_chi_21$cc, model_spec = train_chi_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_chi_19 <- bsts_run(y = train_chi$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_chi)

#2019-2021
model_w_gt_chi_21 <- bsts_run(y = train_chi_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_chi_21)

```

###### BSTS with Google Trends' Categories and Priors

```{r}
model_w_priors_chi_2019 <- bsts_run_w_prior(y = train_chi$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_chi, 
                                            initial_year = 2017, 
                                            spike = 0.8, 
                                            model_size = 4)

model_w_priors_chi_2021 <- bsts_run_w_prior(y = train_chi_21$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_chi_21, 
                                            initial_year = 2019, 
                                            spike = 0.2, 
                                            model_size = 4)
```

###### Results


```{r}
### WITHOUT REGRESSION
#Get the posterior distribution of y and plot it 
pred_wo_gt_chi_19 <- prediction_df_and_plot(model= model_wo_gt_chi_19, 
                                              full_df= df_chi_2019, 
                                              train_df= train_chi, 
                                              test_1= test_chi_oct, 
                                              test_2= test_chi_nov, 
                                              test_3= test_chi_dec, 
                                              reg= FALSE, 
                                            test_year = 2019)

pred_wo_gt_chi_19$plot


pred_wo_gt_chi_21 <- prediction_df_and_plot(model= model_wo_gt_chi_21, 
                                              pred_horizon= 3, 
                                              full_df= df_chi_2021, 
                                              train_df= train_chi_21, 
                                              test_1= test_chi_21_apr, 
                                              test_2= test_chi_21_may, 
                                              test_3= test_chi_21_jun,
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_chi_21$plot
```

```{r}
### WITH REGRESSION

#Get the posterior distribution of y and plot it 
pred_w_gt_chi_19 <- prediction_df_and_plot(model= model_w_gt_chi_19, 
                                              full_df= df_chi_2019, 
                                              train_df= train_chi, 
                                              test_1= test_chi_oct, 
                                              test_2= test_chi_nov, 
                                              test_3= test_chi_dec, 
                                              reg= TRUE)

pred_w_gt_chi_19$plot

pred_w_gt_chi_21 <- prediction_df_and_plot(model= model_w_gt_chi_21, 
                                              full_df= df_chi_2021, 
                                              train_df= train_chi_21, 
                                              test_1= test_chi_21_apr, 
                                              test_2= test_chi_21_may, 
                                              test_3= test_chi_21_jun,
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_chi_21$plot
```


```{r}
### WITH REGRESSION AND PRIORS ON CHOSEN CATEGORIES

##2017-2019
pred_w_priors_chi_2019 <- prediction_df_and_plot(model= model_w_priors_chi_2019, 
                                              full_df= df_chi_2019, 
                                              train_df= train_chi, 
                                              test_1= test_chi_oct, 
                                              test_2= test_chi_nov, 
                                              test_3= test_chi_dec, 
                                              reg= TRUE, 
                                              prior = TRUE)

pred_w_priors_chi_2019$plot



##2019-2021
pred_w_priors_chi_2021 <- prediction_df_and_plot(model= model_w_priors_chi_2021, 
                                              pred_horizon= 3, 
                                              full_df= df_chi_2021, 
                                              train_df= train_chi_21, 
                                              test_1= test_chi_21_apr, 
                                              test_2= test_chi_21_may, 
                                              test_3= test_chi_21_jun,
                                              test_year= 2021,
                                              reg= TRUE,
                                              prior = TRUE)

pred_w_priors_chi_2021$plot
```


```{r}
#Errors
mape_w_gt_chi_19 <- get_errors(MAPE_df = pred_w_gt_chi_19$MAPE_raw, test_year = 2019, country = "Chile", reg = TRUE)
mape_wo_gt_chi_19 <- get_errors(MAPE_df = pred_wo_gt_chi_19$MAPE_raw, test_year = 2019, country = "Chile", reg = FALSE)
mape_w_gt_chi_21 <- get_errors(MAPE_df = pred_w_gt_chi_21$MAPE_raw, test_year = 2021, country = "Chile", reg = TRUE)
mape_wo_gt_chi_21 <- get_errors(MAPE_df = pred_wo_gt_chi_21$MAPE_raw, test_year = 2021, country = "Chile", reg = FALSE)
mape_w_priors_chi_19 <- get_errors(MAPE_df = pred_w_priors_chi_2019$MAPE_raw, test_year = 2019, country = "Chile", reg = TRUE)
mape_w_priors_chi_21 <- get_errors(MAPE_df = pred_w_priors_chi_2021$MAPE_raw, test_year = 2021, country = "Chile", reg = TRUE)
```

#### Spike and Slab Exploration
```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_chi_19, 0.45)
var_inclusion_bsts(model_w_gt_chi_19, 0.03)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_chi_21, 0.7)
var_inclusion_bsts(model_w_gt_chi_21, 0.03)
```
```{r}
PlotBstsComponents(model_w_gt_chi_19,
                     burn = SuggestBurn(.1, model_w_gt_chi_19),
                   time = as.Date(rownames(train_chi)),
                     same.scale = FALSE,
                     layout = "horizontal",
                     style = "dynamic")


PlotBstsComponents(model_wo_gt_chi_19,
                     burn = SuggestBurn(.1, model_wo_gt_chi_19),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_chi)),
                     layout = "horizontal",
                     style = "dynamic")
PlotBstsComponents(model_w_gt_chi_21,
                     burn = SuggestBurn(.1, model_w_gt_chi_21),
                   time = as.Date(rownames(train_chi_21)),
                     same.scale = FALSE,
                     layout = "horizontal",
                     style = "dynamic")


PlotBstsComponents(model_wo_gt_chi_21,
                     burn = SuggestBurn(.1, model_wo_gt_chi_21),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_chi_21)),
                     layout = "horizontal",
                     style = "dynamic")


```

##### Colombia
###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_col_19 <- bsts_run(y = train_col$cc, model_spec = train_col$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_col_21 <- bsts_run(y = train_col_21$cc, model_spec = train_col_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_col_19 <- bsts_run(y = train_col$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_col)

#2019-2021
model_w_gt_col_21 <- bsts_run(y = train_col_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_col_21)

```

###### BSTS with Google Trends' Categories and Priors

```{r}
model_w_priors_col_2019 <- bsts_run_w_prior(y = train_col$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_col, 
                                            initial_year = 2017, 
                                            spike = 0.8, 
                                            model_size = 4)

model_w_priors_col_2021 <- bsts_run_w_prior(y = train_col_21$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_col_21, 
                                            initial_year = 2019, 
                                            spike = 0.2, 
                                            model_size = 4)
```

###### Results


```{r}
### WITHOUT REGRESSION
#Get the posterior distribution of y and plot it 
pred_wo_gt_col_19 <- prediction_df_and_plot(model= model_wo_gt_col_19, 
                                              full_df= df_col_2019, 
                                              train_df= train_col, 
                                              test_1= test_col_oct, 
                                              test_2= test_col_nov, 
                                              test_3= test_col_dec, 
                                              reg= FALSE, 
                                            test_year = 2019)

pred_wo_gt_col_19$plot


pred_wo_gt_col_21 <- prediction_df_and_plot(model= model_wo_gt_col_21, 
                                              pred_horizon= 3, 
                                              full_df= df_col_2021, 
                                              train_df= train_col_21, 
                                              test_1= test_col_21_apr, 
                                              test_2= test_col_21_may, 
                                              test_3= test_col_21_jun,
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_col_21$plot
```

```{r}
### WITH REGRESSION

#Get the posterior distribution of y and plot it 
pred_w_gt_col_19 <- prediction_df_and_plot(model= model_w_gt_col_19, 
                                              full_df= df_col_2019, 
                                              train_df= train_col, 
                                              test_1= test_col_oct, 
                                              test_2= test_col_nov, 
                                              test_3= test_col_dec, 
                                              reg= TRUE)

pred_w_gt_col_19$plot

pred_w_gt_col_21 <- prediction_df_and_plot(model= model_w_gt_col_21, 
                                              full_df= df_col_2021, 
                                              train_df= train_col_21, 
                                              test_1= test_col_21_apr, 
                                              test_2= test_col_21_may, 
                                              test_3= test_col_21_jun,
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_col_21$plot
```


```{r}
### WITH REGRESSION AND PRIORS ON CHOSEN CATEGORIES

##2017-2019
pred_w_priors_col_2019 <- prediction_df_and_plot(model= model_w_priors_col_2019, 
                                              full_df= df_col_2019, 
                                              train_df= train_col, 
                                              test_1= test_col_oct, 
                                              test_2= test_col_nov, 
                                              test_3= test_col_dec, 
                                              reg= TRUE, 
                                              prior = TRUE)

pred_w_priors_col_2019$plot



##2019-2021
pred_w_priors_col_2021 <- prediction_df_and_plot(model= model_w_priors_col_2021, 
                                              pred_horizon= 3, 
                                              full_df= df_col_2021, 
                                              train_df= train_col_21, 
                                              test_1= test_col_21_apr, 
                                              test_2= test_col_21_may, 
                                              test_3= test_col_21_jun,
                                              test_year= 2021,
                                              reg= TRUE,
                                              prior = TRUE)

pred_w_priors_col_2021$plot
```

```{r}
#Errors
mape_w_gt_col_19 <- get_errors(MAPE_df = pred_w_gt_col_19$MAPE_raw, test_year = 2019, country = "Colombia", reg = TRUE)
mape_wo_gt_col_19 <- get_errors(MAPE_df = pred_wo_gt_col_19$MAPE_raw, test_year = 2019, country = "Colombia", reg = FALSE)
mape_w_gt_col_21 <- get_errors(MAPE_df = pred_w_gt_col_21$MAPE_raw, test_year = 2021, country = "Colombia", reg = TRUE)
mape_wo_gt_col_21 <- get_errors(MAPE_df = pred_wo_gt_col_21$MAPE_raw, test_year = 2021, country = "Colombia", reg = FALSE)
mape_w_priors_col_19 <- get_errors(MAPE_df = pred_w_priors_col_2019$MAPE_raw, test_year = 2019, country = "Colombia", reg = TRUE)
mape_w_priors_col_21 <- get_errors(MAPE_df = pred_w_priors_col_2021$MAPE_raw, test_year = 2021, country = "Colombia", reg = TRUE)
```

#### Spike and Slab Exploration
```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_col_19, 0.25)
var_inclusion_bsts(model_w_gt_col_19, 0.01)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_col_21, 0.5)
var_inclusion_bsts(model_w_gt_col_21, 0.02)
```
```{r}
PlotBstsComponents(model_w_gt_col_19,
                     burn = SuggestBurn(.1, model_w_gt_col_19),
                   time = as.Date(rownames(train_col)),
                     same.scale = FALSE,
                     layout = "horizontal",
                     style = "dynamic")


PlotBstsComponents(model_wo_gt_col_19,
                     burn = SuggestBurn(.1, model_wo_gt_col_19),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_col)),
                     layout = "horizontal",
                     style = "dynamic")
PlotBstsComponents(model_w_gt_col_21,
                     burn = SuggestBurn(.1, model_w_gt_col_21),
                   time = as.Date(rownames(train_col_21)),
                     same.scale = FALSE,
                     layout = "horizontal",
                     style = "dynamic")


PlotBstsComponents(model_wo_gt_col_21,
                     burn = SuggestBurn(.1, model_wo_gt_col_21),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_col_21)),
                     layout = "horizontal",
                     style = "dynamic")

```

##### Mexico 

###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_mex_19 <- bsts_run(y = train_mex$cc, model_spec = train_mex$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_mex_21 <- bsts_run(y = train_mex_21$cc, model_spec = train_mex_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_mex_19 <- bsts_run(y = train_mex$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_mex)

#2019-2021
model_w_gt_mex_21 <- bsts_run(y = train_mex_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_mex_21)

```

###### BSTS with Google Trends' Categories and Priors

```{r}
prob_inclusion <- seq(from = 0.2, to = 1, by= 0.2)
prior_models <- length(prob_inclusion)
#2017-2019
#Consider model sizes from 3 to 9
models_w_prior_mex_2019 <- list() #list to store different models
for(p in 1:prior_models){
model <- bsts_run_w_prior(y = train_mex$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_mex, 
                                            initial_year = 2017, 
                                            spike = prob_inclusion[p])

models_w_prior_mex_2019[[p]] <- model 

}


models_w_prior_mex_2021 <- list() 
for(p in 1:prior_models){
model_21 <- bsts_run_w_prior(y = train_mex_21$cc, 
                                            model_spec = cc ~ ., 
                                            seasons = 12, 
                                            iterations = 20000, 
                                            train_df = train_mex_21, 
                                            initial_year = 2019, 
                                            spike = prob_inclusion[p])
models_w_prior_mex_2021[[p]] <- model_21 

}
```


###### Results


```{r}
### WITHOUT REGRESSION
#Get the posterior distribution of y and plot it 
pred_wo_gt_mex_19 <- prediction_df_and_plot(model= model_wo_gt_mex_19, 
                                              full_df= df_mex_2019, 
                                              train_df= train_mex, 
                                              test_1= test_mex_oct, 
                                              test_2= test_mex_nov, 
                                              test_3= test_mex_dec, 
                                              reg= FALSE, 
                                            test_year = 2019)

pred_wo_gt_mex_19$plot


pred_wo_gt_mex_21 <- prediction_df_and_plot(model= model_wo_gt_mex_21, 
                                              pred_horizon= 3, 
                                              full_df= df_mex_2021, 
                                              train_df= train_mex_21, 
                                              test_1= test_mex_21_apr, 
                                              test_2= test_mex_21_may, 
                                              test_3= test_mex_21_jun,
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_mex_21$plot
```

```{r}
### WITH REGRESSION

#Get the posterior distribution of y and plot it 
pred_w_gt_mex_19 <- prediction_df_and_plot(model= model_w_gt_mex_19, 
                                              full_df= df_mex_2019, 
                                              train_df= train_mex, 
                                              test_1= test_mex_oct, 
                                              test_2= test_mex_nov, 
                                              test_3= test_mex_dec, 
                                              reg= TRUE)

pred_w_gt_mex_19$plot

pred_w_gt_mex_21 <- prediction_df_and_plot(model= model_w_gt_mex_21, 
                                              full_df= df_mex_2021, 
                                              train_df= train_mex_21, 
                                              test_1= test_mex_21_apr, 
                                              test_2= test_mex_21_may, 
                                              test_3= test_mex_21_jun,
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_mex_21$plot
```

```{r}
### WITH REGRESSION AND PRIORS ON CHOSEN CATEGORIES

##2017-2019
pred_w_gt_prior_mex_19 <- list()

for(p in 1:prior_models){
pred_w_gt_prior_mex_19[[p]] <- prediction_df_and_plot(model = models_w_prior_mex_2019[[p]] , 
                                              full_df = df_mex_2019, 
                                              train_df = train_mex, 
                                              test_1= test_mex_oct, 
                                              test_2= test_mex_nov, 
                                              test_3= test_mex_dec, 
                                              prior = TRUE,
                                              reg= TRUE)
}
##2019-2021
pred_w_gt_prior_mex_21  <- list()

for(p in 1:prior_models){

pred_w_gt_prior_mex_21[[p]] <- prediction_df_and_plot(model = models_w_prior_mex_2021[[p]] ,  
                                              full_df= df_mex_2021, 
                                              train_df= train_mex_21, 
                                              test_1= test_mex_21_apr, 
                                              test_2= test_mex_21_may, 
                                              test_3= test_mex_21_jun,
                                              reg= TRUE, 
                                              prior = TRUE,
                                              test_year = 2021)

}
```

```{r}
#Plot the model with the smaller error (prior)
pred_w_gt_prior_mex_19[[4]]$plot

pred_w_gt_prior_mex_21[[2]]$plot
```

```{r}
PlotBstsComponents(model_w_gt_mex_19,
                     burn = SuggestBurn(.1, model_w_gt_mex_19),
                     same.scale = FALSE,
                   time = as.Date(rownames(train_mex)),
                     layout = "horizontal",
                     style = "dynamic") 


PlotBstsComponents(models_w_prior_mex_2019[[4]],
                     burn = SuggestBurn(.1, models_w_prior_mex_2019[[4]]),
                   time = as.Date(rownames(train_mex)),
                     same.scale = FALSE,
                     layout = "horizontal",
                     style = "dynamic")

PlotBstsComponents(models_w_prior_mex_2021[[2]],
                     burn = SuggestBurn(.1, models_w_prior_mex_2021[[2]]),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_mex_21)),
                     layout = "horizontal",
                     style = "dynamic")

PlotBstsComponents(model_w_gt_mex_21,
                     burn = SuggestBurn(.1, model_w_gt_mex_21),
                     same.scale = FALSE,
                     time = as.Date(rownames(train_mex_21)),
                     layout = "horizontal",
                     style = "dynamic")

```



```{r}
#See errors of model w. priors first
errors_prior_mex_2019  <- NULL
errors_prior_mex_2021  <- NULL
for (p in 1:prior_models)
    {
    errors_prior_mex_2019 <- rbind(errors_prior_mex_2019, 
                                get_errors(MAPE_df = pred_w_gt_prior_mex_19[[p]]$MAPE_raw, test_year = 2019, country = "Mexico", reg = TRUE))
}

errors_prior_mex_2019 <- cbind(errors_prior_mex_2019, prob_inclusion)

for (p in 1:prior_models)
    {
    errors_prior_mex_2021 <- rbind(errors_prior_mex_2021, 
                                get_errors(MAPE_df = pred_w_gt_prior_mex_21[[p]]$MAPE_raw, test_year = 2021, country = "Mexico", reg = TRUE))
}

errors_prior_mex_2021 <- cbind(errors_prior_mex_2021, prob_inclusion)

errors_prior_mex <- rbind(errors_prior_mex_2019, errors_prior_mex_2021)

write_xlsx(errors_prior_mex, "errors_prior_mex.xlsx")
```

```{r}
#Errors
mape_w_gt_mex_19 <- get_errors(MAPE_df = pred_w_gt_mex_19$MAPE_raw, test_year = 2019, country = "Mexico", reg = TRUE)
mape_wo_gt_mex_19 <- get_errors(MAPE_df = pred_wo_gt_mex_19$MAPE_raw, test_year = 2019, country = "Mexico", reg = FALSE)
mape_w_gt_mex_21 <- get_errors(MAPE_df = pred_w_gt_mex_21$MAPE_raw, test_year = 2021, country = "Mexico", reg = TRUE)
mape_wo_gt_mex_21 <- get_errors(MAPE_df = pred_wo_gt_mex_21$MAPE_raw, test_year = 2021, country = "Mexico", reg = FALSE)
mape_w_priors_mex_19 <- get_errors(MAPE_df = pred_w_gt_prior_mex_19[[4]]$MAPE_raw, test_year = 2019, country = "Mexico", reg = TRUE)
mape_w_priors_mex_21 <- get_errors(MAPE_df = pred_w_gt_prior_mex_21[[2]]$MAPE_raw, test_year = 2021, country = "Mexico", reg = TRUE)
```

#### Spike and Slab Exploration
```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_mex_19, 0.1)
var_inclusion_bsts(model_w_gt_mex_19, 0.01)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_mex_21, 0.15)
var_inclusion_bsts(model_w_gt_mex_21, 0.03)


#Relevant variables 2017-2019
param_values_bsts(models_w_prior_mex_2019[[4]], 0.01)
var_inclusion_bsts(models_w_prior_mex_2019[[4]], 0.01)

#Relevant variables 2019-2021
param_values_bsts(models_w_prior_mex_2021[[2]], 0.01)
var_inclusion_bsts(models_w_prior_mex_2021[[2]], 0.01)
```

```{r}
errors_df <- rbind(mape_wo_gt_arg_19, mape_wo_gt_arg_21,mape_w_gt_arg_19, mape_w_gt_arg_21, mape_w_priors_arg_19, mape_w_priors_arg_21, 
                   mape_wo_gt_bra_19, mape_wo_gt_bra_21,mape_w_gt_bra_19, mape_w_gt_bra_21, mape_w_priors_bra_19, mape_w_priors_bra_21, 
                   mape_wo_gt_chi_19, mape_wo_gt_chi_21,mape_w_gt_chi_19, mape_w_gt_chi_21, mape_w_priors_chi_19, mape_w_priors_chi_21, 
                   mape_wo_gt_col_19, mape_wo_gt_col_21,mape_w_gt_col_19, mape_w_gt_col_21, mape_w_priors_col_19, mape_w_priors_col_21, 
                   mape_wo_gt_mex_19, mape_wo_gt_mex_21,mape_w_gt_mex_19, mape_w_gt_mex_21, mape_w_priors_mex_19, mape_w_priors_mex_21)

write_xlsx(errors_df, "final_errors_table.xlsx")
```

