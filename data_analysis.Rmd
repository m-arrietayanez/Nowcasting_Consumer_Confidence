---
title: " Initial Data Analysis"
subtitle: "Nowcasting Lating America with Google Trends"
author: "Mariana Arrieta Yanez"
date: "7/2/2021"
output: pdf_document
---

#### Data Loading


```{r, message=FALSE, echo=FALSE}
library(tidyverse)
library(data.table)
library(lubridate)
library(gtrendsR)
library(janitor)
library(tools)
library(bsts)
library(scales)
library(writexl)

```

```{r}
#Load all csv files in folder
temp = list.files(pattern="*.csv")
for (i in 1:length(temp)) assign(file_path_sans_ext(temp[i]), read.csv(temp[i]))

#Load google trends categories
data("categories")

#Convert ID number from character to integer to merge later
categories <- categories %>%
  mutate(id = as.integer(id)) %>%
  rename(category = id) %>%
  distinct() 
```

#### Data Cleaning and Processing

##### Google Trends Data
```{r, message=FALSE, warning=FALSE}

#Argentina
arg_dfs <- list(arg_2017_2019, arg_2019_2021)
for(i in 1:2) { 
 nam <- paste("arg", i, sep = "")
 assign(nam, processing_gt_monthly(arg_dfs[i]))
}

#Brasil
bra_dfs <- list(bra_2017_2019, bra_2019_2021)
for(i in 1:2) { 
 nam <- paste("bra", i, sep = "")
 assign(nam, processing_gt_monthly(bra_dfs[i]))
}


#Colombia
col_dfs <- list(col_2017_2019, col_2019_2021)
for(i in 1:2) { 
 nam <- paste("col", i, sep = "")
 assign(nam, processing_gt_monthly(col_dfs[i]))
}


#Chile
chi_dfs <- list(chi_2017_2019, chi_2019_2021)
for(i in 1:2) { 
 nam <- paste("chi", i, sep = "")
 assign(nam, processing_gt_monthly(chi_dfs[i]))
}



#Mexico
mex_dfs <- list(mex_2017_2019, mex_2019_2021)
for(i in 1:2) { 
 nam <- paste("mex", i, sep = "")
 assign(nam, processing_gt_monthly(mex_dfs[i]))
}



```

##### Consumer Confidence 


```{r}

#LOAD CONSUMER CONFIDENCE DATA#

#Argentina
cc_arg <- process_cc("argentina")

#Brasil
cc_bra <- process_cc("brasil")

#Chile
cc_chi <- process_cc("chile")

#Colombia
cc_col <- process_cc("colombia")

#Mexico
cc_mex <- process_cc("mexico")


#MERGE CONSUMER CONFIDENCE DATA WITH GOOGLE TRENDS DATA

#Argentina
df_arg_2019 <- merge_and_label(df_gt = arg1, df_cc = cc_arg)

df_arg_2021 <- merge_and_label(arg2, cc_arg)


#Brasil
df_bra_2019 <- merge_and_label(df_gt = bra1, df_cc = cc_bra)

df_bra_2021 <- merge_and_label(bra2, cc_bra)

#Chile
df_chi_2019 <- merge_and_label(df_gt = chi1, df_cc = cc_chi)

df_chi_2021 <- merge_and_label(chi2, cc_chi)

#Colombia
df_col_2019 <- merge_and_label(df_gt = col1, df_cc = cc_col)

df_col_2021 <- merge_and_label(col2, cc_col)

#Mexico
df_mex_2019 <- merge_and_label(df_gt = mex1, df_cc = cc_mex)

df_mex_2021 <- merge_and_label(mex2, cc_mex)
```

#### Split Training and Test Sets
```{r}

#ARGENTINA

#2017-2019

my_list <- split_train_test(df_arg_2019, initial_year = 2017)
train_arg <- my_list$train
test_arg <- my_list$test

#2019-2021

my_list <- split_train_test(df_arg_2021, initial_year = 2019)
train_arg_21 <- my_list$train
test_arg_21  <- my_list$test
```

```{r}

#BRASIL

#2017-2019

my_list <- split_train_test(df_bra_2019, initial_year = 2017)
train_bra <- my_list$train
test_bra <- my_list$test

#2019-2021

my_list <- split_train_test(df_bra_2021, initial_year = 2019)
train_bra_21 <- my_list$train
test_bra_21  <- my_list$test
```


```{r}

#CHILE

#2017-2019

my_list <- split_train_test(df_chi_2019, initial_year = 2017)
train_chi <- my_list$train
test_chi <- my_list$test

#2019-2021

my_list <- split_train_test(df_chi_2021, initial_year = 2019)
train_chi_21 <- my_list$train
test_chi_21  <- my_list$test
```


```{r}

#COLOMBIA

#2017-2019

my_list <- split_train_test(df_col_2019, initial_year = 2017)
train_col <- my_list$train
test_col <- my_list$test

#2019-2021

my_list <- split_train_test(df_col_2021, initial_year = 2019)
train_col_21 <- my_list$train
test_col_21  <- my_list$test
```


```{r}

#MEXICO

#2017-2019

my_list <- split_train_test(df_mex_2019, initial_year = 2017)
train_mex <- my_list$train
test_mex <- my_list$test

#2019-2021

my_list <- split_train_test(df_mex_2021, initial_year = 2019)
train_mex_21 <- my_list$train
test_mex_21  <- my_list$test
```

#### Modeling and Results

##### Argentina 

###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_arg_19 <- bsts_run(y = train_arg$cc, model_spec = train_arg$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_arg_21 <- bsts_run(y = train_arg_21$cc, model_spec = train_arg_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_arg_19 <- bsts_run(y = train_arg$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_arg)

#2019-2021
model_w_gt_arg_21 <- bsts_run(y = train_arg_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_arg_21)

```


###### Results

```{r}
#Get the posterior distribution of y and plot it 
pred_wo_gt_arg_19 <- prediction_df_and_plot(model= model_wo_gt_arg_19, 
                                              pred_horizon= 3, 
                                              full_df= df_arg_2019, 
                                              train_df= train_arg, 
                                              test_df= test_arg, 
                                              reg= FALSE, 
                                            test_year = 2019)

pred_wo_gt_arg_19$plot


pred_wo_gt_arg_21 <- prediction_df_and_plot(model= model_wo_gt_arg_21, 
                                              pred_horizon= 3, 
                                              full_df= df_arg_2021, 
                                              train_df= train_arg_21, 
                                              test_df= test_arg_21, 
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_arg_21$plot
```
```{r}

```


```{r}

#Get the posterior distribution of y and plot it 
pred_w_gt_arg_19 <- prediction_df_and_plot(model= model_w_gt_arg_19, 
                                              pred_horizon= 3, 
                                              full_df= df_arg_2019, 
                                              train_df= train_arg, 
                                              test_df= test_arg, 
                                              reg= TRUE)

pred_w_gt_arg_19$plot

pred_w_gt_arg_21 <- prediction_df_and_plot(model= model_w_gt_arg_21, 
                                              pred_horizon= 3, 
                                              full_df= df_arg_2021, 
                                              train_df= train_arg_21, 
                                              test_df= test_arg_21, 
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_arg_21$plot
```
```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_arg_19, 0.1)
var_inclusion_bsts(model_w_gt_arg_19)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_arg_21, 0.1)
var_inclusion_bsts(model_w_gt_arg_21)
```


```{r}
#Errors
mape_w_gt_arg_19 <- get_errors(MAPE_df = pred_w_gt_arg_19$MAPE_raw, test_year = 2019, country = "argentina", reg = TRUE)
mape_wo_gt_arg_19 <- get_errors(MAPE_df = pred_wo_gt_arg_19$MAPE_raw, test_year = 2019, country = "argentina", reg = FALSE)
mape_w_gt_arg_21 <- get_errors(MAPE_df = pred_w_gt_arg_21$MAPE_raw, test_year = 2021, country = "argentina", reg = TRUE)
mape_wo_gt_arg_21 <- get_errors(MAPE_df = pred_wo_gt_arg_21$MAPE_raw, test_year = 2021, country = "argentina", reg = FALSE)
```


##### Brasil 

###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_bra_19 <- bsts_run(y = train_bra$cc, model_spec = train_bra$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_bra_21 <- bsts_run(y = train_bra_21$cc, model_spec = train_bra_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_bra_19 <- bsts_run(y = train_bra$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_bra)

#2019-2021
model_w_gt_bra_21 <- bsts_run(y = train_bra_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_bra_21)

```


###### Results

```{r}
#Get the posterior distribution of y and plot it 
pred_wo_gt_bra_19 <- prediction_df_and_plot(model= model_wo_gt_bra_19, 
                                              pred_horizon= 3, 
                                              full_df= df_bra_2019, 
                                              train_df= train_bra, 
                                              test_df= test_bra, 
                                              reg= FALSE)

pred_wo_gt_bra_19$plot

pred_wo_gt_bra_21 <- prediction_df_and_plot(model= model_wo_gt_bra_21, 
                                              pred_horizon= 3, 
                                              full_df= df_bra_2021, 
                                              train_df= train_bra_21, 
                                              test_df= test_bra_21, 
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_bra_21$plot
```

```{r}

#Get the posterior distribution of y and plot it 
pred_w_gt_bra_19 <- prediction_df_and_plot(model= model_w_gt_bra_19, 
                                              pred_horizon= 3, 
                                              full_df= df_bra_2019, 
                                              train_df= train_bra, 
                                              test_df= test_bra, 
                                              reg= TRUE)

pred_w_gt_bra_19$plot

pred_w_gt_bra_21 <- prediction_df_and_plot(model= model_w_gt_bra_21, 
                                              pred_horizon= 3, 
                                              full_df= df_bra_2021, 
                                              train_df= train_bra_21, 
                                              test_df= test_bra_21, 
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_bra_21$plot
```

```{r}
#Errors
mape_w_gt_bra_19 <- get_errors(MAPE_df = pred_w_gt_bra_19$MAPE_raw, test_year = 2019, country = "brasil", reg = TRUE)
mape_wo_gt_bra_19 <- get_errors(MAPE_df = pred_wo_gt_bra_19$MAPE_raw, test_year = 2019, country = "brasil", reg = FALSE)
mape_w_gt_bra_21 <- get_errors(MAPE_df = pred_w_gt_bra_21$MAPE_raw, test_year = 2021, country = "brasil", reg = TRUE)
mape_wo_gt_bra_21 <- get_errors(MAPE_df = pred_wo_gt_bra_21$MAPE_raw, test_year = 2021, country = "brasil", reg = FALSE)
```

```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_bra_19, 0.2)
var_inclusion_bsts(model_w_gt_bra_19, 0.002)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_bra_21, 0.4)
var_inclusion_bsts(model_w_gt_bra_21, 0.02)
```


##### Chile 

###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_chi_19 <- bsts_run(y = train_chi$cc, model_spec = train_chi$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_chi_21 <- bsts_run(y = train_chi_21$cc, model_spec = train_chi_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_chi_19 <- bsts_run(y = train_chi$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_chi)

#2019-2021
model_w_gt_chi_21 <- bsts_run(y = train_chi_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_chi_21)

```


###### Results

```{r}
#Get the posterior distribution of y and plot it 
pred_wo_gt_chi_19 <- prediction_df_and_plot(model= model_wo_gt_chi_19, 
                                              pred_horizon= 3, 
                                              full_df= df_chi_2019, 
                                              train_df= train_chi, 
                                              test_df= test_chi, 
                                              reg= FALSE)

pred_wo_gt_chi_19$plot

pred_wo_gt_chi_21 <- prediction_df_and_plot(model= model_wo_gt_chi_21, 
                                              pred_horizon= 3, 
                                              full_df= df_chi_2021, 
                                              train_df= train_chi_21, 
                                              test_df= test_chi_21, 
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_chi_21$plot
```

```{r}

#Get the posterior distribution of y and plot it 
pred_w_gt_chi_19 <- prediction_df_and_plot(model= model_w_gt_chi_19, 
                                              pred_horizon= 3, 
                                              full_df= df_chi_2019, 
                                              train_df= train_chi, 
                                              test_df= test_chi, 
                                              reg= TRUE)

pred_w_gt_chi_19$plot

pred_w_gt_chi_21 <- prediction_df_and_plot(model= model_w_gt_chi_21, 
                                              pred_horizon= 3, 
                                              full_df= df_chi_2021, 
                                              train_df= train_chi_21, 
                                              test_df= test_chi_21, 
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_chi_21$plot
```


```{r}
#Errors
mape_w_gt_chi_19 <- get_errors(MAPE_df = pred_w_gt_chi_19$MAPE_raw, test_year = 2019, country = "chile", reg = TRUE)
mape_wo_gt_chi_19 <- get_errors(MAPE_df = pred_wo_gt_chi_19$MAPE_raw, test_year = 2019, country = "chile", reg = FALSE)
mape_w_gt_chi_21 <- get_errors(MAPE_df = pred_w_gt_chi_21$MAPE_raw, test_year = 2021, country = "chile", reg = TRUE)
mape_wo_gt_chi_21 <- get_errors(MAPE_df = pred_wo_gt_chi_21$MAPE_raw, test_year = 2021, country = "chile", reg = FALSE)
```

```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_chi_19, 0.5)
var_inclusion_bsts(model_w_gt_chi_19, 0.002)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_chi_21, 0.6)
var_inclusion_bsts(model_w_gt_chi_21, 0.005)
```


##### Colombia 

###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_col_19 <- bsts_run(y = train_col$cc, model_spec = train_col$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_col_21 <- bsts_run(y = train_col_21$cc, model_spec = train_col_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_col_19 <- bsts_run(y = train_col$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_col)

#2019-2021
model_w_gt_col_21 <- bsts_run(y = train_col_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_col_21)

```


###### Results

```{r}
#Get the posterior distribution of y and plot it 
pred_wo_gt_col_19 <- prediction_df_and_plot(model= model_wo_gt_col_19, 
                                              pred_horizon= 3, 
                                              full_df= df_col_2019, 
                                              train_df= train_col, 
                                              test_df= test_col, 
                                              reg= FALSE)

pred_wo_gt_col_19$plot


pred_wo_gt_col_21 <- prediction_df_and_plot(model= model_wo_gt_col_21, 
                                              pred_horizon= 3, 
                                              full_df= df_col_2021, 
                                              train_df= train_col_21, 
                                              test_df= test_col_21, 
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_col_21$plot
```

```{r}

#Get the posterior distribution of y and plot it 
pred_w_gt_col_19 <- prediction_df_and_plot(model= model_w_gt_col_19, 
                                              pred_horizon= 3, 
                                              full_df= df_col_2019, 
                                              train_df= train_col, 
                                              test_df= test_col, 
                                              reg= TRUE)

pred_w_gt_col_19$plot

pred_w_gt_col_21 <- prediction_df_and_plot(model= model_w_gt_col_21, 
                                              pred_horizon= 3, 
                                              full_df= df_col_2021, 
                                              train_df= train_col_21, 
                                              test_df= test_col_21, 
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_col_21$plot
```



```{r}
#Errors
mape_w_gt_col_19 <- get_errors(MAPE_df = pred_w_gt_col_19$MAPE_raw, test_year = 2019, country = "colombia", reg = TRUE)
mape_wo_gt_col_19 <- get_errors(MAPE_df = pred_wo_gt_col_19$MAPE_raw, test_year = 2019, country = "colombia", reg = FALSE)
mape_w_gt_col_21 <- get_errors(MAPE_df = pred_w_gt_col_21$MAPE_raw, test_year = 2021, country = "colombia", reg = TRUE)
mape_wo_gt_col_21 <- get_errors(MAPE_df = pred_wo_gt_col_21$MAPE_raw, test_year = 2021, country = "colombia", reg = FALSE)
```


```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_col_19, 0.2)
var_inclusion_bsts(model_w_gt_col_19, 0.002)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_col_21, 0.5)
var_inclusion_bsts(model_w_gt_col_21, 0.005)
```


##### Mexico 

###### BSTS with no Google Trends' Categories
```{r}
#2017-2019
model_wo_gt_mex_19 <- bsts_run(y = train_mex$cc, model_spec = train_mex$cc, seasons = 12, iterations = 1000)

#2019-2021
model_wo_gt_mex_21 <- bsts_run(y = train_mex_21$cc, model_spec = train_mex_21$cc, seasons = 12, iterations = 1000)
```

###### BSTS with Google Trends' Categories
```{r}
#2017-2019
model_w_gt_mex_19 <- bsts_run(y = train_mex$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_mex)

#2019-2021
model_w_gt_mex_21 <- bsts_run(y = train_mex_21$cc, model_spec = cc ~ ., seasons = 12, iterations = 20000, df = train_mex_21)

```


###### Results

```{r}
#Get the posterior distribution of y and plot it 
pred_wo_gt_mex_19 <- prediction_df_and_plot(model= model_wo_gt_mex_19, 
                                              pred_horizon= 3, 
                                              full_df= df_mex_2019, 
                                              train_df= train_mex, 
                                              test_df= test_mex, 
                                              reg= FALSE)

pred_wo_gt_mex_19$plot

pred_wo_gt_mex_21 <- prediction_df_and_plot(model= model_wo_gt_mex_21, 
                                              pred_horizon= 3, 
                                              full_df= df_mex_2021, 
                                              train_df= train_mex_21, 
                                              test_df= test_mex_21, 
                                              reg= FALSE, 
                                              test_year = 2021)


pred_wo_gt_mex_21$plot
```

```{r}

#Get the posterior distribution of y and plot it 
pred_w_gt_mex_19 <- prediction_df_and_plot(model= model_w_gt_mex_19, 
                                              pred_horizon= 3, 
                                              full_df= df_mex_2019, 
                                              train_df= train_mex, 
                                              test_df= test_mex, 
                                              reg= TRUE)

pred_w_gt_mex_19$plot

pred_w_gt_mex_21 <- prediction_df_and_plot(model= model_w_gt_mex_21, 
                                              pred_horizon= 3, 
                                              full_df= df_mex_2021, 
                                              train_df= train_mex_21, 
                                              test_df= test_mex_21, 
                                              reg= TRUE, 
                                              test_year = 2021)


pred_w_gt_mex_21$plot
```


```{r}
#Errors
mape_w_gt_mex_19 <- get_errors(MAPE_df = pred_w_gt_mex_19$MAPE_raw, test_year = 2019, country = "mexico", reg = TRUE)
mape_wo_gt_mex_19 <- get_errors(MAPE_df = pred_wo_gt_mex_19$MAPE_raw, test_year = 2019, country = "mexico", reg = FALSE)
mape_w_gt_mex_21 <- get_errors(MAPE_df = pred_w_gt_mex_21$MAPE_raw, test_year = 2021, country = "mexico", reg = TRUE)
mape_wo_gt_mex_21 <- get_errors(MAPE_df = pred_wo_gt_mex_21$MAPE_raw, test_year = 2021, country = "mexico", reg = FALSE)
```


```{r}

#Create dataframe with all errors
errors_df2 <- rbind(mape_wo_gt_arg_19,mape_w_gt_arg_19, mape_wo_gt_arg_21, mape_w_gt_arg_21,
                   mape_wo_gt_bra_19,mape_w_gt_bra_19, mape_wo_gt_bra_21, mape_w_gt_bra_21,
                   mape_wo_gt_chi_19,mape_w_gt_chi_19, mape_wo_gt_chi_21, mape_w_gt_chi_21,
                   mape_wo_gt_col_19,mape_w_gt_col_19, mape_wo_gt_col_21, mape_w_gt_col_21,
                   mape_wo_gt_mex_19,mape_w_gt_mex_19, mape_wo_gt_mex_21, mape_w_gt_mex_21)

errors_df$MAPE_train <- label_percent()(errors_df$MAPE_train)
errors_df$MAPE_test <- label_percent()(errors_df$MAPE_test)

#Export to Excel 
write_xlsx(errors_df2,"errors_file2.xlsx")

```

```{r}
#Relevant variables 2017-2019
param_values_bsts(model_w_gt_mex_19, 0.1)
var_inclusion_bsts(model_w_gt_mex_19, 0.002)

#Relevant variables 2019-2021
param_values_bsts(model_w_gt_mex_21, 0.2)
var_inclusion_bsts(model_w_gt_mex_21, 0.01)
```

```{r, fig.height= 4}
CompareBstsModels(list("Without Regressors" = model_wo_gt_col_19,
                         "With Regressors" = model_w_gt_col_19, 
                       "With Regressors and Priors" = model_w_priors_col_2019), 
                  colors = c("black", "red", "blue"))
```
